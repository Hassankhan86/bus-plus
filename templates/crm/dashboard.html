{% extends "crm/base/base.html" %}
{% load static %}

{% block style %}

{% endblock style %}
{% block content %}


                <div class="page-content">
                    <div class="container-fluid">

                        <!-- start page title -->
                        <div class="row">
                            <div class="col-12">
                                <div class="page-title-box d-sm-flex align-items-center justify-content-between">


                                    <div class="page-title-right">
                                        <ol class="breadcrumb m-0">
                                            <li class="breadcrumb-item"><a href="javascript: void(0);">Dashboard</a></li>

                                        </ol>
                                    </div>

                                </div>
                            </div>
                        </div>
                        <!-- end page title -->



                        <div class="row">

                            <div class="col-xl-12">
                                <div class="row">
                                    <div class="col-sm-3">
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="d-flex align-items-center mb-3">
                                                    <div class="avatar-xs me-3">
                                                        <span class="avatar-title rounded-circle bg-primary bg-soft text-primary font-size-18">
                                                            <i class="bx bx-copy-alt"></i>
                                                        </span>
                                                    </div>
                                                    <h5 class="font-size-14 mb-0">Buses</h5>
                                                </div>
                                                <div class="text-muted mt-4">
                                                    <h4>{{ buses }} <i class="mdi mdi-chevron-up ms-1 text-success"></i></h4>
                                                    <div class="d-flex">
                                                        <span class="badge badge-soft-{% if buses_percentage_change >= 0 %}success {% else %}warning {% endif %}  font-size-12"> {% if buses_percentage_change >= 0 %} + {% else %} - {% endif %}  {{ buses_percentage_change }}% </span> <span class="ms-2 text-truncate">From previous period</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-3">
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="d-flex align-items-center mb-3">
                                                    <div class="avatar-xs me-3">
                                                        <span class="avatar-title rounded-circle bg-primary bg-soft text-primary font-size-18">
                                                            <i class="bx bx-copy-alt"></i>
                                                        </span>
                                                    </div>
                                                    <h5 class="font-size-14 mb-0">Orders</h5>
                                                </div>
                                                <div class="text-muted mt-4">
                                                    <h4>{{ current_orders_count }} <i class="mdi mdi-chevron-up ms-1 text-success"></i></h4>
                                                    <div class="d-flex">
                                                        <span class="badge badge-soft-success font-size-12"> + 0.2% </span> <span class="ms-2 text-truncate">From previous period</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-3">
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="d-flex align-items-center mb-3">
                                                    <div class="avatar-xs me-3">
                                                        <span class="avatar-title rounded-circle bg-primary bg-soft text-primary font-size-18">
                                                            <i class="bx bx-archive-in"></i>
                                                        </span>
                                                    </div>
                                                    <h5 class="font-size-14 mb-0">Revenue</h5>
                                                </div>
                                                <div class="text-muted mt-4">
                                                    <h4>$ {{ current_total_revenue }} <i class="mdi mdi-chevron-up ms-1 text-success"></i></h4>
                                                    <div class="d-flex">
                                                        <span class="badge badge-soft-{% if current_total_revenue >= 0 %}success {% else %}warning {% endif %} font-size-12"> {% if current_total_revenue >= 0 %} + {% else %} - {% endif %}  {{ revenue_percentage_change }}% </span> <span class="ms-2 text-truncate">From previous period</span>
                                                    </div>



                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-sm-3">
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="d-flex align-items-center mb-3">
                                                    <div class="avatar-xs me-3">
                                                        <span class="avatar-title rounded-circle bg-primary bg-soft text-primary font-size-18">
                                                            <i class="bx bx-purchase-tag-alt"></i>
                                                        </span>
                                                    </div>
                                                    <h5 class="font-size-14 mb-0">Average Order Price</h5>
                                                </div>
                                                <div class="text-muted mt-4">
                                                    <h4>$ {{ current_avg_order_price }} <i class="mdi mdi-chevron-up ms-1 text-success"></i></h4>

                                                    <div class="d-flex">
                                                        <span class="badge badge-soft-{% if current_avg_order_price >= 0 %}success {% else %}warning {% endif %}  font-size-12"> {% if current_avg_order_price >= 0 %} + {% else %} - {% endif %}  {{ avg_order_price_percentage_change }}% </span> <span class="ms-2 text-truncate">From previous period</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- end row -->
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-xl-8">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="clearfix">
                                            <div class="float-end">
                                                <div class="input-group input-group-sm">
                                                     <select class="form-select form-select-sm" id="monthFilter">

                                                        {% for month in available_months %}
                                                        <option value="{{ forloop.counter }}" {% if selected_month == forloop.counter %}selected{% endif %}>{{ month }}</option>
                                                        {% endfor %}
                                                    </select>
                                                    <select class="form-select form-select-sm" id="yearFilter">

                                                        {% for year in available_years %}
                                                        <option value="{{ year }}" {% if selected_year == year %}selected{% endif %}>{{ year }}</option>
                                                        {% endfor %}
                                                    </select>

                                                    <label class="input-group-text">Month & Year</label>
                                                </div>
                                            </div>
                                            <h4 class="card-title mb-4">Earning</h4>
                                        </div>

                                        <div class="row">
                                            <div class="col-lg-4">
                                                <div class="text-muted">
                                                    <div class="mb-4">
                                                        <p>This month</p>
                                                        <h4>${{ current_month_data }}</h4>
                                                        <div><span class="badge badge-soft-success font-size-12 me-1"> + 0.2% </span> From previous period</div>
                                                    </div>



                                                    <div class="mt-4">
                                                        <p class="mb-2">Last month</p>
                                                        <h5>${{ previous_month_data }}</h5>
                                                    </div>

                                                </div>
                                            </div>

                                             <div class="col-lg-8">
                                                <div id="line-chart" class="apex-charts" data-colors='["--bs-primary"]' dir="ltr"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-xl-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h4 class="card-title mb-4">Sales Analytics</h4>

                                        <div>
                                            <div id="donut-chart" data-colors='["--bs-primary", "--bs-success", "--bs-danger"]' class="apex-charts"></div>
                                        </div>

                                        <div class="text-center text-muted">
                                            <div class="row">
                                                {% for des_location in top_destination_locations %}
                                                	<div class="col-4">
                                                    <div class="mt-4">
                                                        <p class="mb-2 text-truncate"><i class="mdi mdi-circle text-primary me-1"></i> {{ des_location.destination }}</p>
                                                        <h5>$ {{ des_location.total_earnings }}</h5>
                                                    </div>
                                                </div>
                                                {% endfor %}

                                            </div>
                                        </div>
                                    </div>
                                </div>
                                 <div class="card">
                                    <div class="card-body">
                                        <h4 class="card-title mb-4">Pickups Sales Analytics</h4>

                                        <div>
                                            <div id="donut-chart" data-colors='["--bs-primary", "--bs-success", "--bs-danger"]' class="apex-charts"></div>
                                        </div>

                                        <div class="text-center text-muted">
                                            <div class="row">
                                                {% for pickup_location in top_pickup_locations %}
                                                	<div class="col-4">
                                                    <div class="mt-4">
                                                        <p class="mb-2 text-truncate"><i class="mdi mdi-circle text-primary me-1"></i> {{ pickup_location.pickup }}</p>
                                                        <h5>$ {{ pickup_location.total_earnings }}</h5>
                                                    </div>
                                                </div>
                                                {% endfor %}



                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div> <!-- container-fluid -->
                <div class="row">
                            <div class="col-lg-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h4 class="card-title mb-4">Latest Transaction</h4>
                                        <div class="table-responsive">
                                            <table class="table align-middle table-nowrap mb-0">
                                                <thead class="table-light">
                                                    <tr>

                                                        <th class="align-middle">OrderID</th>
                                                        <th class="align-middle">Customer Name</th>
                                                        <th class="align-middle">Date</th>

                                                        <th class="align-middle">Total Amount</th>
                                                        <th class="align-middle">Order Status</th>
                                                        <th class="align-middle">Payment Status</th>
                                                        <th class="align-middle">Payment GateWay</th>
                                                        <th class="align-middle">View</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                {% for  order  in recent_20_orders %}
                                                    <tr>

                                                        <td><a href="javascript: void(0);" class="text-body fw-bold">#{{ order.order_id }}</a> </td>
                                                        <td>{{ order.get_customer_full_name }}</td>
                                                        <td>
                                                            {{ order.created_at.date }}
                                                        </td>
                                                        <td>
                                                            ${{ order.grand_total }}
                                                        </td>
                                                        <td>
                                                            <span class="badge badge-pill badge-soft-{{ order.order_status_color }} font-size-11">{{ order.order_status }}</span>
                                                        </td>
                                                        <td>
                                                            <span class="badge badge-pill badge-soft-{{ order.get_payment.payment_status_color }} font-size-11">{{ order.get_payment.payment_status }}</span>
                                                        </td>
                                                        <td>
                                                            <i class="fab fa-cc-mastercard me-1"></i> {{ order.get_payment.payment_gateway }}
                                                        </td>
                                                        <td>
                                                            <a
                                                            href="{% url 'orders_view' order.id %}"
                                                            target="_blank"
                                                            ><button type="button" class="btn btn-primary btn-sm btn-rounded">
                                                                View Details
                                                            </button></a>
                                                            <!-- Button trigger modal -->

                                                        </td>
                                                    </tr>
                                                    {% endfor %}

                                                </tbody>
                                            </table>
                                        </div>
                                        <!-- end table-responsive -->
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>


{% endblock content%}


{% block scripts %}
    <script>
    document.addEventListener('DOMContentLoaded', function () {

        const monthFilter = document.getElementById('monthFilter');
        const yearFilter = document.getElementById('yearFilter');
        const listOfValues = JSON.parse('{{ listOfValues|safe }}');
        const _values = listOfValues.map(value => parseFloat(value.toString()));


        const options = {
            chart: {
                type: 'line',
                height: 350
            },
             xaxis: {
            categories: {{ listOfLabels|safe }}
        },
        series: [{
            name: 'Earnings',
            data: _values
        }]
        };
        const lineChart = new ApexCharts(document.querySelector("#line-chart"), options);




        monthFilter.addEventListener('change', updateChart);
        yearFilter.addEventListener('change', updateChart);

        function updateChart() {
            const selectedMonth = monthFilter.value;
            const selectedYear = yearFilter.value;

            fetch(`/crm/api/get_chart_data/?month=${selectedMonth}&year=${selectedYear}`)
                .then(response => response.json())
                .then(data => {
                    const labels = data.labels;
                        const values = data.values.map(value => parseFloat(value));

                        lineChart.updateSeries([{ name: "Earnings", data: values }]);
                        lineChart.updateOptions({
                            xaxis: {
                                categories: labels
                            }
                        });
                });
        }

        // Initial chart setup


        // Initialize the chart
        lineChart.render();
    });
</script>

{% endblock scripts %}


